---
interface Props {
  productsData: any[];
  setTitle: string;
}

const { productsData, setTitle } = Astro.props;
---

<div class="shop-container">
  <div class="shop-header">
    <h1 class="shop-title">{setTitle}</h1>
  </div>

  <div class="products-container">
    {productsData.map((product, index) => (
      <div class="product-card">
        <a href={`/shop/${product.scarf_name.toLowerCase().replace(/\s+/g, '-')}`}>
          <div class="product-image-container">
            <!-- Add a placeholder while the image loads -->
            <div class="image-placeholder"></div>
            
            <!-- Improved image with proper attributes -->
            <img 
              src={product.product_image} 
              alt={product.scarf_name}
              class="product-image"
              loading={index < 6 ? "eager" : "lazy"} 
              decoding="async"
              width="600"
              height="600"
              data-image
              data-index={index}
              onload="this.classList.add('loaded'); this.closest('.product-image-container')?.classList.add('image-loaded');"
              onerror="this.closest('.product-image-container')?.classList.add('image-error');"
            />
            
            <div class="loading-skeleton"></div>
            <div class="product-overlay">
              <button class="view-button">View Scarf</button>
            </div>
          </div>
        </a>
        
        <div class="product-info">
          <h3 class="product-name">{product.scarf_name}</h3>
          <div class="product-price">â‚¹1000</div>
        </div>
      </div>
    ))}
  </div>
</div>

<style>
  .shop-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    color: #e3bcae;
  }

  .shop-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }
  .shop-title {
    font-size: 2.5rem;
    font-weight: 400;
    margin-bottom: 0.5rem;
    font-family: "Changa";
    letter-spacing: 3px;
  }

  .products-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6rem;
    margin-bottom: 1rem;
    justify-content: center;
    font-family: "Aldrich", sans-serif;
  }

  .product-card {
    background: #1e4941;
    overflow: hidden;
    transition: all 0.3s ease;
    flex: 0 1 calc(33.333% - 7rem);
    min-width: 0;
  }

  @media (max-width: 1024px) {
    .product-card {
      flex: 0 1 calc(50% - 3rem);
    }
  }

  @media (max-width: 640px) {
    .product-card {
      flex: 0 1 calc(50% - 2rem);
      margin-bottom: 1rem;
    }
    
    .products-container {
      gap: 2rem;
    }
    .shop-title{
      font-size: 1.5rem;
    }
    .product-name{
      font-size: 0.8rem !important;
      margin-top: 0.1rem !important;
    }
    .product-price{
      font-size: 0.6rem !important;
    }
  }

  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .product-image-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    background: #f8f8f8;
    aspect-ratio: 1 / 1;
  }

  .image-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #f0f0f0;
    z-index: 1;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.5s ease, opacity 0.3s ease;
    background: transparent;
    opacity: 0;
    position: relative;
    z-index: 2;
  }

  .product-image.loaded {
    opacity: 1;
  }

  .loading-skeleton {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    z-index: 3;
    display: none; /* Hide by default, show via JS */
  }

  .product-image-container:not(.image-loaded):not(.image-error) .loading-skeleton {
    display: block;
  }

  .product-image-container.image-loaded .loading-skeleton,
  .product-image-container.image-error .loading-skeleton {
    display: none;
  }

  .product-card:hover .product-image {
    transform: scale(1.05);
  }

  .product-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 4;
  }

  .product-card:hover .product-overlay {
    opacity: 1;
  }

  .view-button {
    background: white;
    color: #1a1a1a;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: "Aldrich", sans-serif;
    font-weight: 300;
    font-size: 0.8rem;
  }

  .view-button:hover {
    background: #1a1a1a;
    color: white;
    transform: scale(1.05);
  }

 .product-info {
    padding: 0.8rem;
    text-align: center;
  }

  .product-name {
    margin-top: 0.3rem;
    margin-bottom: 0.3rem;
    font-weight: 400;
  }

  .product-price {
    font-size: 1.1rem;
    font-weight: 400;
    margin: 0;
  }

  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }
</style>

<script>
  // Preload critical images for better performance
  document.addEventListener('DOMContentLoaded', function() {
    // Preload the first 3 images for immediate display
    const criticalImages = document.querySelectorAll('img[data-index="0"], img[data-index="1"], img[data-index="2"]');
    criticalImages.forEach(img => {
      // Type guard to ensure we're working with HTMLImageElement
      if (img instanceof HTMLImageElement) {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'image';
        link.href = img.src;
        document.head.appendChild(link);
      }
    });
    
    // Initialize image loading states
    const images = document.querySelectorAll('img[data-image]');
    
    images.forEach(img => {
      const container = img.closest('.product-image-container');
      
      // Type guard to ensure we're working with HTMLImageElement
      if (img instanceof HTMLImageElement) {
        // If image is already loaded
        if (img.complete) {
          img.classList.add('loaded');
          container?.classList.add('image-loaded');
        } else {
          // Add loading state
          container?.classList.add('image-loading');
          
          // Set up error handling
          img.addEventListener('error', function() {
            container?.classList.remove('image-loading');
            container?.classList.add('image-error');
          });
        }
      }
    });
  });
</script>